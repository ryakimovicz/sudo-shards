:root {
  --primary-color: #6c5ce7;
  --secondary-color: #a29bfe;
  --accent-color: #fdcb6e;
  --bg-gradient: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
  --glass-bg: rgba(255, 255, 255, 0.1);
  --glass-border: rgba(255, 255, 255, 0.2);
  --text-color: #ffffff;
  --success-color: #00b894;
  --error-color: #ff7675;
}

* {
  box-sizing: border-box;
  margin: 0;
  padding: 0;
}

body {
  font-family: "Outfit", sans-serif;
  color: var(--text-color);
  width: 100vw;
  height: 100dvh; /* Dynamic viewport height */
  overflow: hidden; /* Prevent scrolling */
  display: flex;
  flex-direction: column; /* Stack VERTICALLY */
  justify-content: center; /* CENTER ALIGNMENT */
  align-items: center; /* Center horizontally */
  background: var(--bg-gradient);
  margin: 0;
  padding-top: 0;
}

/* Hide the outer header to allow perfect panel centering */
header {
  display: none;
}

#game-scaler {
  transform-origin: center center; /* Scale from center */
  transition: transform 0.1s ease-out;
  display: flex;
  flex-direction: column;
  align-items: center;
  justify-content: center;
  width: 100%;
  max-width: 1000px;
  /* CRITICAL: No vertical margin to prevent centering/pushing down */
  margin: 0 auto;
}

.background-animation {
  position: absolute;
  top: 0;
  left: 0;
  width: 100%;
  height: 100%;
  z-index: -1;
  background-size: 400% 400%;
  animation: gradientBG 15s ease infinite;
}

@keyframes gradientBG {
  0% {
    background-position: 0% 50%;
  }
  50% {
    background-position: 100% 50%;
  }
  100% {
    background-position: 0% 50%;
  }
}

.game-container {
  width: 100%; /* Fill the scaler */
  text-align: center;
  margin: 0 auto;
  padding: 0; /* Remove padding */
  display: flex; /* Ensure flex behavior */
  flex-direction: column;
  justify-content: center;
  align-items: center;
  height: 100%; /* Ensure full height */
}

/* ... */

.jigsaw-pools-wrapper {
  position: absolute;
  top: 0;
  left: 0;
  width: 100%;
  height: 100%;
  pointer-events: auto; /* Enable interaction for background drops */
  display: block; /* Remove flex, use block/absolute */
  /* Remove flex layout props since we use absolute positioning */
  justify-content: space-between;
  align-items: center;
  padding: 0 40px; /* More padding */
  z-index: 1;
}

#jigsaw-stage {
  position: absolute;
  top: 0;
  left: 0;
  width: 100%;
  height: 100%;
  z-index: 5; /* Below board (10) but above background */
  pointer-events: none; /* Let clicks pass to underlying elements unless on valid children */
}

/* Default: Wrapper handles layout but lets clicks pass (for Memory stage) */
#jigsaw-stage .jigsaw-pools-wrapper {
  pointer-events: none;
}

/* Interactive Mode (Stage 1): Catch drops on background */
#jigsaw-stage.interactive .jigsaw-pools-wrapper {
  pointer-events: auto;
}

.side-pool {
  width: 140px;
  display: flex;
  flex-direction: column;
  gap: 10px;
  align-items: center;
  pointer-events: auto;
  background: rgba(255, 255, 255, 0.1); /* Visible container */
  padding: 10px;
  border-radius: 10px;
}

header {
  margin-bottom: 5px; /* Reduced from 20px */
  margin-top: 0;
}

h1 {
  font-size: 2.5rem;
  margin-bottom: 2px; /* Reduced from 10px */
  margin-top: 0;
  text-shadow: 0 2px 4px rgba(0, 0, 0, 0.2);
}

.game-subtitle {
  font-family: "Outfit", sans-serif; /* Explicitly ensure font matches */
  font-size: 1.5rem;
  margin-bottom: 5px;
  color: #ffffff; /* User requested better visibility (was #a29bfe) */
  text-shadow: 0 2px 5px rgba(0, 0, 0, 0.3); /* Add shadow for contrast against glass */
  text-transform: uppercase;
  letter-spacing: 2px;
}

/* Global Full Screen Panel */
.glass-panel {
  background: var(--glass-bg);
  backdrop-filter: blur(10px);
  -webkit-backdrop-filter: blur(10px);
  border: 1px solid var(--glass-border);
  border-radius: 20px;
  padding: 20px;
  box-shadow: 0 8px 32px 0 rgba(31, 38, 135, 0.37);
  transition: all 0.5s ease;
  overflow: hidden; /* THE WALL: Strict Containment */

  /* Dimensions: Full Screen with minimal margins */
  width: calc(100vw - 30px);
  height: calc(100dvh - 30px);
  margin: auto; /* Let flex center handle it */
  max-width: none; /* remove limits */
  min-height: 0; /* remove limits */

  display: flex;
  flex-direction: column;
  justify-content: flex-start;
  align-items: center;
  position: relative;

  /* Remove top padding hack, use flex spacing */
  padding-top: 20px;
}

/* Update Game Container to allow full width */
.game-container {
  width: 100%;
  height: 100%;
  margin: 0;
  padding: 0;
  display: flex;
  justify-content: center;
  align-items: center;
}

#game-scaler {
  /* Disable scaler constraints visually, 
     though JS might still try to scale, 
     but with 100vw content it should result in close to 1.0 scale */
  width: 100%;
  max-width: none;
  height: 100%;
}

/* Hide global header since we want to focus on panel content? 
   No, user said title INSIDE panel. 
   We should probably hide the outer header globally if the panel has the new title.
   But game stages rely on subtitle.
   Let's ensure outer header doesn't take space if possible. */

/* Mobile override not needed as much if global is fluid, 
   but specific adjustments can remain. Align with main breakpoint (767px). */
@media (max-width: 767px) {
  .glass-panel {
    /* Just ensure margins are slightly smaller on mobile */
    width: calc(100vw - 20px);
    height: calc(100dvh - 20px);
    margin: 10px auto;
  }
}

/* Height-based Layout Adjustments for Laptops (e.g. 1366x768) */
@media (max-height: 900px) {
  .glass-panel {
    padding-top: 20px; /* Slight bump back up so it's not too crowded */
    padding-bottom: 20px;
    min-height: 600px; /* Ensure it's tall enough (16:9 safe) to trigger height scaling */
  }
  header {
    margin-bottom: 0;
  }
  h1 {
    font-size: 2rem;
  }
}

.stage {
  width: 100%;
  display: flex;
  flex-direction: column;
  align-items: center;
  transition:
    opacity 0.5s ease,
    transform 0.5s ease;
}

.hidden {
  display: none;
  opacity: 0;
  transform: scale(0.95);
}

.active {
  display: flex;
  opacity: 1;
  transform: scale(1);
}

/* Shared Board Dimensions */
/* Shared Board Dimensions */
:root {
  /* Responsive Scaling: Width OR Height constrained */
  /* 5vh ensures board (9 cells height) < 50% of screen height */
  --cell-size: min(40px, 10.5vmin, 4.5vh);
  --board-size: calc(var(--cell-size) * 9);

  /* Card Size: Constrain by height too */
  --card-size: min(75px, 14vmin, 9vh);
}

#main-board {
  position: relative;
  z-index: 10;
  margin: 0 auto 10px auto;
  /* Enforce Square Shape */
  width: var(--board-size);
  height: var(--board-size);
  min-height: var(--board-size); /* Prevent collapsing */
  aspect-ratio: 1 / 1;

  display: flex;
  justify-content: center;
  align-items: center;

  /* Visual Definition: 3x3 Grid Simulation */
  background-color: rgba(0, 0, 0, 0.2);
  background-image:
    linear-gradient(#555 1px, transparent 1px),
    linear-gradient(90deg, #555 1px, transparent 1px);
  background-size: 33.33% 33.33%; /* 3x3 Grid */

  border: 3px solid #333;
  box-shadow: 0 4px 10px rgba(0, 0, 0, 0.1);
  box-sizing: content-box; /* Match drop-zone behavior */
}

.drop-zone {
  width: calc(var(--board-size) + 6px); /* + borders */
  height: calc(var(--board-size) + 6px);
  display: grid;
  grid-template-columns: repeat(3, 1fr);
  grid-template-rows: repeat(3, 1fr);
  border: 3px solid #333; /* Match sudoku border */
  background: rgba(0, 0, 0, 0.2);
  box-sizing: content-box; /* Ensure inner width is 360 */
  margin: 0 auto; /* Ensure centered if needed */
}

/* Jigsaw Styles */

/* On mobile, revert to stacked. 
   User request: 768px (Tablets) should be DESKTOP. */
@media (max-width: 767px) {
  #jigsaw-stage {
    position: relative;
    top: auto;
    left: auto;
    margin-bottom: 20px;
    order: 2; /* Middle */
  }

  /* Wrapper acts as container for all pieces */
  .jigsaw-pools-wrapper {
    position: static;
    height: auto;
    min-height: 180px; /* Reserve space for 2 rows of pieces (80px*2 + gaps) */
    display: flex;
    flex-direction: row; /* Flow pieces horizontally */
    flex-wrap: wrap; /* Wrap to new lines (rows) */
    justify-content: center;
    align-items: center;
    pointer-events: auto;
    margin-top: 0;
    gap: 10px;
    padding: 10px;
    width: 100%;
  }

  /* Turn each side pool into a functional horizontal row */
  .side-pool {
    display: flex;
    flex-direction: row; /* Pieces flow horizontally */
    flex-wrap: wrap; /* Allow wrapping if many pieces */
    justify-content: center;
    align-items: center;
    width: 100%;
    gap: 5px;
  }

  /* Collected pieces styling - ensure they fit */
  .jigsaw-pools-wrapper .jigsaw-piece {
    position: relative !important;
    left: auto !important;
    top: auto !important;
    margin: 3px;
    transform: none; /* Reset scale, use real size */
    width: 80px !important; /* Larger as requested */
    height: 80px !important;
    font-size: 11px;
    box-shadow: 0 2px 4px rgba(0, 0, 0, 0.2);
  }

  .jigsaw-pools-wrapper .jigsaw-cell {
    width: 26px; /* ~80/3 */
    height: 26px;
    font-size: 0.9rem;
  }

  /* Memory Stage at bottom */
  #memory-stage {
    order: 3;
    margin-top: 20px;
  }

  .memory-board {
    display: flex;
    flex-wrap: wrap;
    justify-content: center;
    gap: 10px;
  }
}

/* Very Small Screens Adjustments (e.g. iPhone SE 320px) */
@media (max-width: 450px) {
  :root {
    --cell-size: 32px; /* Board becomes ~288px + borders fits in 320px */
  }

  /* Shrink memory cards */
  .memory-card {
    width: 65px;
    height: 65px;
  }

  .memory-card .jigsaw-cell {
    font-size: 10px; /* Smaller font inside small cards */
    border-width: 0.5px;
  }

  /* Shrink collected pieces to fit 4 per row */
  .jigsaw-pools-wrapper .jigsaw-piece {
    width: 60px !important; /* 60*4 = 240 + gaps fits in 300px */
    height: 60px !important;
    font-size: 9px;
  }

  .jigsaw-pools-wrapper .jigsaw-cell {
    width: 20px;
    height: 20px;
  }
}

.jigsaw-piece {
  width: 120px; /* 3 * 40px */
  height: 120px;
  background: white;
  color: #333;
  display: grid;
  grid-template-columns: repeat(3, 1fr);
  grid-template-rows: repeat(3, 1fr);
  font-size: 14px;
  border: 1px solid #333;
  cursor: grab;
  user-select: none;
  box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
}

.jigsaw-cell {
  width: 40px;
  height: 40px;
  display: flex;
  justify-content: center;
  align-items: center;
  border: 1px solid #ddd;
  font-weight: bold;
  font-size: 1.2rem; /* Match sudoku font */
}

/* ID based override to be 100% sure */
#center-fixed-piece {
  pointer-events: none !important;
  user-select: none !important;
  border: 2px solid rgba(255, 255, 255, 0.5); /* Visual indicator */
}

.jigsaw-piece.fixed-piece {
  cursor: default; /* Not draggable */
  box-shadow: inset 0 0 10px rgba(0, 0, 0, 0.5); /* Visual visual anchor */
  pointer-events: none !important; /* FORCE DISABLE INTERACTION */
  user-select: none !important;
}

.jigsaw-piece.selected {
  border-color: var(--accent-color) !important;
  box-shadow:
    0 0 15px var(--accent-color),
    0 0 5px white;
  z-index: 100 !important;
  transform: scale(1.1);
}

.jigsaw-piece.dragging {
  opacity: 0.5;
  transform: scale(1.05);
}

.jigsaw-piece.error-highlight {
  box-shadow: 0 0 15px 5px #ff7675;
  border: 2px solid #ff7675 !important;
  z-index: 100;
  animation: shake 0.5s;
}

@keyframes shake {
  0% {
    transform: translate(1px, 1px) rotate(0deg);
  }
  10% {
    transform: translate(-1px, -2px) rotate(-1deg);
  }
  20% {
    transform: translate(-3px, 0px) rotate(1deg);
  }
  30% {
    transform: translate(3px, 2px) rotate(0deg);
  }
  40% {
    transform: translate(1px, -1px) rotate(1deg);
  }
  50% {
    transform: translate(-1px, 2px) rotate(-1deg);
  }
  60% {
    transform: translate(-3px, 1px) rotate(0deg);
  }
  70% {
    transform: translate(3px, 1px) rotate(-1deg);
  }
  80% {
    transform: translate(-1px, -1px) rotate(1deg);
  }
  90% {
    transform: translate(1px, 2px) rotate(0deg);
  }
  100% {
    transform: translate(1px, -2px) rotate(-1deg);
  }
}

/* Sudoku Styles */
.sudoku-container {
  width: calc(var(--board-size) + 8px); /* 4px * 2 borders */
  height: calc(var(--board-size) + 8px);
  display: grid;
  grid-template-columns: repeat(9, 1fr);
  gap: 0;
  background: #333;
  border: 4px solid #000; /* Thicker container border */
  margin-bottom: 20px;
  box-sizing: content-box;
}

.sudoku-cell {
  width: 40px;
  height: 40px;
  background: white;
  display: flex;
  justify-content: center;
  align-items: center;
  font-size: 1.2rem;
  color: #2d3436;
  cursor: pointer;
  /* Default thin borders */
  border-right: 1px solid #333;
  border-bottom: 1px solid #333;
  box-sizing: border-box; /* Ensure borders are inside the cell dimensions */
}

.sudoku-cell.fixed {
  background: #dfe6e9;
  font-weight: bold;
  color: #2d3436;
  cursor: default;
}

.sudoku-cell.selected {
  background: #a29bfe;
}

.sudoku-cell.error {
  background: #ff7675;
  color: white;
}

/* Borders for 3x3 blocks */
/* Every 3rd column gets thicker right border */
.sudoku-cell:nth-child(3n) {
  border-right: 3px solid #000;
}
/* Last column - Remove right border (use container border) */
.sudoku-cell:nth-child(9n) {
  border-right: none;
}

/* Rows 3 and 6 get thicker bottom border.
   Correct Logic: 
   Row 3 ends at index 27 (19-27 range is correct row 3).
   Row 6 ends at index 54 (46-54 range is correct row 6).
   But Grid is flat list of 81 divs.
*/
.sudoku-cell:nth-child(n + 19):nth-child(-n + 27),
.sudoku-cell:nth-child(n + 46):nth-child(-n + 54) {
  border-bottom: 3px solid #000;
}

/* Last Row - Remove bottom border */
.sudoku-cell:nth-child(n + 73) {
  border-bottom: none;
}

.sudoku-controls {
  display: flex;
  flex-direction: column;
  gap: 15px;
}

.number-pad {
  display: flex;
  gap: 5px;
}

.num-btn {
  width: 30px;
  height: 30px;
  border-radius: 50%;
  border: none;
  background: white;
  font-weight: bold;
  cursor: pointer;
  transition: transform 0.2s;
}

.num-btn:hover {
  transform: scale(1.1);
  background: var(--accent-color);
}

.sudoku-cell.cracked {
  background-color: #ffeaa7 !important;
  background-image:
    linear-gradient(
      45deg,
      transparent 48%,
      #5d4037 49%,
      #5d4037 51%,
      transparent 52%
    ),
    linear-gradient(
      -45deg,
      transparent 48%,
      #5d4037 49%,
      #5d4037 51%,
      transparent 52%
    ) !important;
  background-size: 100% 100% !important;
  opacity: 0.9;
  border-color: #5d4037 !important;
  pointer-events: none; /* Cannot be clicked again */
}

/* Ensure cracked cells look distinct even if they were even/odd/highlighted */
.sudoku-cell.cracked.peak {
  box-shadow: inset 0 0 10px rgba(0, 0, 0, 0.2);
}

/* Number Search Styles */
.search-wrapper {
  display: flex;
  justify-content: center;
  align-items: center;
  margin-bottom: 20px;
}

.search-container {
  display: grid;
  grid-template-columns: repeat(9, 1fr);
  gap: 2px;
  background: #333;
  padding: 2px;
  border-radius: 4px;
}

.search-cell {
  width: 35px;
  height: 35px;
  background: white;
  display: flex;
  justify-content: center;
  align-items: center;
  font-size: 1.2rem;
  font-weight: bold;
  color: #2d3436;
  cursor: pointer;
  user-select: none;
  transition: background 0.1s;
}

.sudoku-cell.search-mode {
  cursor: crosshair; /* Indicate selection mode */
  user-select: none;
}

.sudoku-cell.search-mode.selected {
  background: var(--accent-color);
  color: #2d3436;
}

/* Ensure found targets are highlighted inside standard layout */
.sudoku-cell.search-mode.found {
  background: var(--success-color);
  color: white;
  animation: pulse 0.5s ease;
}

/* Targets List */
.targets-container {
  display: flex;
  flex-wrap: wrap;
  gap: 10px;
  justify-content: center;
  margin-bottom: 20px;
}

.target-item {
  background: rgba(255, 255, 255, 0.2);
  padding: 5px 10px;
  border-radius: 5px;
  font-family: monospace;
  font-size: 1.2rem;
  letter-spacing: 2px;
}

.target-item.done {
  text-decoration: line-through;
  opacity: 0.5;
  background: rgba(0, 184, 148, 0.2);
}

@keyframes pulse {
  0% {
    transform: scale(1);
  }
  50% {
    transform: scale(1.1);
  }
  100% {
    transform: scale(1);
  }
}

/* Buttons */
.btn-primary {
  padding: 12px 24px;
  background: var(--primary-color);
  color: white;
  border: none;
  border-radius: 25px;
  font-size: 1rem;
  cursor: pointer;
  transition:
    background 0.3s ease,
    transform 0.2s;
  box-shadow: 0 4px 6px rgba(0, 0, 0, 0.2);
}

.btn-primary:hover {
  background: #5649c0;
  transform: translateY(-2px);
}

.btn-tool {
  padding: 8px 16px;
  margin: 0 5px;
  border: 2px solid transparent;
  border-radius: 15px;
  cursor: pointer;
  background: rgba(255, 255, 255, 0.2);
  color: white;
}

.btn-tool.active {
  border-color: var(--accent-color);
  background: rgba(255, 255, 255, 0.4);
}

@media (max-width: 600px) {
  .drop-zone {
    width: calc(var(--board-size) + 6px);
    height: calc(var(--board-size) + 6px);
  }
  .sudoku-cell {
    width: 32px;
    height: 32px;
    font-size: 1rem;
  }
  .nono-cell {
    width: 25px;
    height: 25px;
  }
}

/* Memory Game Styles */
.memory-layout {
  display: flex;
  flex-direction: column; /* Stack vertically */
  gap: 10px; /* Reduced from 60px to fix overflow */
  justify-content: center;
  align-items: center;
}

/* Board (Collected) on TOP */
.memory-sidebar {
  display: contents; /* Remove sidebar box styling */
  order: 1;
}

/* Cards on BOTTOM */
.memory-board {
  display: grid;
  grid-template-columns: repeat(6, 1fr);
  gap: 15px;
  perspective: 1000px;
  order: 2;
}

.memory-sidebar h3 {
  display: none; /* Hide "Piezas:" title if redundant */
}

.collected-container {
  display: grid;
  grid-template-columns: repeat(3, 1fr);
  grid-template-rows: repeat(3, 1fr);
  gap: 0; /* No gaps between pieces in the "board" view */
  width: calc(var(--board-size) + 6px);
  height: calc(var(--board-size) + 6px);
  border: 3px solid #333;
  padding: 0;
  background: rgba(0, 0, 0, 0.1);
  box-sizing: content-box;
  margin-bottom: 40px;
}

/* Override mini-piece for the collected container to be full size */
.collected-container .mini-piece {
  width: 120px;
  height: 120px;
  /* Reuse jigsaw-piece grid logic implicitly or explicit */
  display: grid;
  grid-template-columns: repeat(3, 1fr);
  grid-template-rows: repeat(3, 1fr);
}

.collected-container .jigsaw-cell {
  /* Inherits 40px size from global rule if class reused */
}

.memory-card {
  width: var(--card-size);
  height: var(--card-size);
  position: relative;
  transform-style: preserve-3d;
  transition: transform 0.5s;
  cursor: pointer;
}

/* Mini pieces in cards need scaling */
/* Fix for actual class used by JS (renderJigsawPiece) */
.memory-card .jigsaw-piece {
  width: 100%;
  height: 100%;
  display: grid;
  grid-template-columns: repeat(3, 1fr);
  grid-template-rows: repeat(3, 1fr);
  box-shadow: none; /* Remove shadow in card to avoid clutter */
  border: none;
}

.memory-card .jigsaw-cell {
  width: auto; /* Allow flex/grid to sizing */
  height: auto;
  font-size: 16px; /* Larger font for visibility */
  border-width: 1px;
}

.memory-card.flipped {
  transform: rotateY(180deg);
}

.card-front,
.card-back {
  width: 100%;
  height: 100%;
  position: absolute;
  backface-visibility: hidden;
  border-radius: 8px;
  display: flex;
  justify-content: center;
  align-items: center;
  border: 2px solid rgba(255, 255, 255, 0.2);
  box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
}

.card-back {
  background: linear-gradient(
    135deg,
    var(--primary-color),
    var(--secondary-color)
  );
  font-size: 2rem;
}

.card-front {
  background: white;
  transform: rotateY(180deg);
  overflow: hidden; /* To verify piece content stays inside */
}

/* Reuse jigsaw piece styling but scaled down for cards/collected */
.mini-piece {
  width: 100%;
  height: 100%;
  display: grid;
  grid-template-columns: repeat(3, 1fr);
  grid-template-rows: repeat(3, 1fr);
  font-size: 8px; /* Smaller font for numbers */
  color: #333;
}

/* Peaks Stage Styles */
.peaks-info {
  margin-bottom: 15px;
  font-size: 1.1rem;
}

.peaks-cell {
  width: 40px;
  height: 40px;
  background: white;
  display: flex;
  justify-content: center;
  align-items: center;
  font-size: 1.2rem;
  font-weight: bold;
  color: #333;
  cursor: pointer;
  transition: background 0.2s;
}

.peaks-cell:hover {
  background: #dfe6e9;
}

.peaks-cell.found {
  background: var(--success-color);
  color: white;
  animation: pulse 0.3s ease;
}

.peaks-cell.error {
  background: var(--error-color);
  color: white;
}
/* Animations */

@keyframes fusePieces {
  0% {
    transform: scale(1);
    border-color: transparent;
  }
  50% {
    transform: scale(1.02);
    box-shadow: 0 0 15px var(--primary-color);
  }
  100% {
    transform: scale(1);
    border: none;
    gap: 0;
  }
}

.jigsaw-completed .jigsaw-piece {
  border: none;
  box-shadow: none;
}
.jigsaw-completed .jigsaw-slot {
  border: none !important;
}
.jigsaw-completed {
  animation: fuseBoard 1s forwards;
  background: white; /* Unified background */
  gap: 0;
}

@keyframes fuseBoard {
  from {
    gap: 0;
  }
  to {
    gap: 0;
  }
}

/* Board Transitions */
.stage-transition {
  transition: all 0.8s ease-in-out;
}

/* Sudoku <-> Peaks (Same size) */
/* Peaks -> Search (Shrink) */
.board-shrink {
  animation: shrinkBoard 0.8s forwards;
}

@keyframes shrinkBoard {
  from {
    transform: scale(1);
  }
  to {
    transform: scale(0.9);
  }
}

/* Jigsaw -> Sudoku (Expand) */
.board-expand {
  animation: expandBoard 0.8s forwards;
}

@keyframes expandBoard {
  from {
    transform: scale(0.85);
    opacity: 0;
  }
  to {
    transform: scale(1);
    opacity: 1;
  }
}

@keyframes flyAway {
  0% {
    transform: scale(1) translateY(0);
    opacity: 1;
  }
  100% {
    transform: scale(0.5) translateY(-50px);
    opacity: 0;
  }
}
.fly-away {
  animation: flyAway 0.8s forwards;
}

/* Very Small Screens Adjustments (e.g. iPhone SE 320px) */
@media (max-width: 450px) {
  :root {
    --cell-size: 29px;
    --board-size: 261px; /* Hardcoded fallback */
  }

  /* Force fix board width */
  #main-board,
  .drop-zone,
  .collected-container {
    width: 265px !important; /* ~29*9 + border */
    height: 265px !important;
    max-width: 100%;
    margin: 0 auto 20px auto;
  }

  /* Reduce panel padding to prevent overflow */
  .glass-panel {
    padding: 10px;
  }

  /* Memory Board: Switch to Flexbox to center last row items */
  .memory-board {
    display: flex;
    flex-wrap: wrap;
    justify-content: center;
    gap: 8px; /* Tighter gaps */
    width: 100%; /* Ensure it fits container */
  }

  /* Shrink memory cards */
  .memory-card {
    width: 60px;
    height: 60px;
  }

  .memory-card .jigsaw-cell {
    font-size: 10px;
    border-width: 0.5px;
  }

  /* Shrink collected pieces & gaps */
  .jigsaw-pools-wrapper .jigsaw-piece {
    width: 60px !important;
    height: 60px !important;
    font-size: 9px;
    font-size: 9px;
    margin: 2px;
  }

  /* Update min-height for smaller pieces (60px * 2 rows roughly) */
  .jigsaw-pools-wrapper {
    min-height: 130px;
  }

  .jigsaw-pools-wrapper .jigsaw-cell {
    width: 20px;
    height: 20px;
  }
}

/* --- Header Refactor Styles --- */

.panel-header {
  width: 100%;
  display: flex;
  justify-content: center;
  align-items: center; /* Vertically align text and icon */
  gap: 10px;
  margin-bottom: 10px; /* Space before hint button/board */
  position: relative; /* For tooltip positioning */
  z-index: 30; /* Fix: Higher than btn-hint (20) to show tooltip on top */
  margin-top: 60px; /* SPACE FOR ANIMATED TITLE */
}

/* Ensure subtitle has no bottom margin to align with icon */
.game-subtitle {
  margin-bottom: 0;
}

/* Info Icon */
.info-icon {
  width: 18px; /* Reduced from 24px */
  height: 18px;
  background: rgba(255, 255, 255, 0.2);
  border-radius: 50%;
  display: flex;
  justify-content: center;
  align-items: center;
  cursor: pointer;
  font-size: 12px; /* Reduced from 18px to match new size */
  font-weight: 400; /* Normal weight */
  font-family: "Outfit", sans-serif;
  color: white;
  border: 2px solid rgba(255, 255, 255, 0.8);
  transition: all 0.2s ease;
  user-select: none;
}

.info-icon:hover {
  background: var(--accent-color);
  color: #333;
  transform: scale(1.1);
}

/* Tooltip Container */
.info-tooltip {
  position: absolute;
  top: 100%; /* Below header */
  left: 50%;
  transform: translateX(-50%);

  background: rgba(0, 0, 0, 0.8);
  backdrop-filter: blur(5px);
  -webkit-backdrop-filter: blur(5px);

  padding: 15px;
  border-radius: 10px;
  border: 1px solid rgba(255, 255, 255, 0.1);
  box-shadow: 0 4px 15px rgba(0, 0, 0, 0.5);

  width: max-content;
  max-width: 80%; /* Don't overflow panel */
  margin-top: 10px;
  z-index: 100;

  text-align: center;
  font-size: 1rem;
  color: #fff;

  opacity: 1;
  visibility: visible;
  transition:
    opacity 0.3s ease,
    transform 0.3s ease;
}

/* Tooltip Arrow */
.info-tooltip::after {
  content: "";
  position: absolute;
  bottom: 100%; /* Top of tooltip */
  left: 50%;
  margin-left: -8px;
  border-width: 8px;
  border-style: solid;
  border-color: transparent transparent rgba(0, 0, 0, 0.8) transparent;
}

/* Hidden State */
.hidden-tooltip {
  opacity: 0;
  visibility: hidden;
  transform: translateX(-50%) translateY(-10px);
}

/* Hover Interaction (Desktop) */
@media (hover: hover) {
  .info-icon:hover ~ .info-tooltip {
    opacity: 1;
    visibility: visible;
    transform: translateX(-50%) translateY(0);
  }
}

/* Hint Button Adjustments */
.btn-hint {
  margin: 0 auto 20px auto; /* Space below header, above board */
  display: block;
  padding: 8px 16px; /* Slightly smaller than main actions */
  font-size: 0.9rem;
  position: relative; /* Fix: Needed for z-index */
  z-index: 20; /* Fix: Ensure it stays above Jigsaw overlay */
}

/* Adjusted Instruction Text */
#instruction-text {
  margin: 0; /* Remove default p margin inside tooltip */
  line-height: 1.4;
}

/* Debug Floating Button */
.debug-floating-btn {
  position: fixed;
  bottom: 20px;
  right: 20px;
  z-index: 9999;
  box-shadow: 0 4px 15px rgba(0, 0, 0, 0.3);
  opacity: 0.8;
  transition:
    opacity 0.3s,
    transform 0.2s;
}

.debug-floating-btn:hover {
  opacity: 1;
  transform: scale(1.05);
}
/* Start Menu Styles */
#start-menu {
  position: absolute;
  top: 0;
  left: 0;
  width: 100%;
  height: 100%;
  display: flex;
  flex-direction: column;
  justify-content: center;
  align-items: center;
  z-index: 50;
}

.start-header {
  position: absolute;
  top: 30px;
  width: 100%;
  text-align: center;
}

.start-header h1 {
  font-size: 4rem;
  margin: 0;
  text-shadow: 0 4px 10px rgba(0, 0, 0, 0.3);
}

.start-header p {
  font-size: 1.1rem;
  max-width: 90%;
  line-height: 1.5;
  opacity: 0.9;
  margin: 10px auto 0 auto;
}

#start-btn {
  font-size: 2rem;
  padding: 20px 80px;
  box-shadow: 0 10px 25px rgba(108, 92, 231, 0.5);
  border-radius: 50px;
}

/* Mobile Adjustments for Start Menu */
@media (max-width: 600px) {
  .start-header {
    top: 20px; /* Less top space */
  }

  .start-header h1 {
    font-size: 2.5rem; /* Smaller Title */
  }

  .start-header p {
    font-size: 0.95rem; /* Smaller Text */
    line-height: 1.4;
    max-width: 95%;
  }

  #start-btn {
    font-size: 1.5rem;
    padding: 15px 50px;
  }
}

@media (max-height: 500px) {
  /* Landscape mobile or very short screens */
  .start-header {
    position: relative; /* Return to flow if height is too small */
    top: auto;
    margin-bottom: 20px;
  }
  #start-menu {
    justify-content: center; /* Center everything together */
    padding-top: 20px;
  }
}
/* Unified App Title Styles */
.app-title {
  position: absolute;
  left: 50%;
  transform: translate(-50%, 0);
  margin: 0;
  text-shadow: 0 4px 10px rgba(0, 0, 0, 0.3);
  transition: all 0.8s cubic-bezier(0.68, -0.55, 0.265, 1.55); /* Bouncy transition */
  z-index: 100; /* Above everything */
  width: 100%;
  text-align: center;
}

/* State 1: Start Menu Mode (Centered, Large) */
.app-title.start-mode {
  top: 25%; /* Explicit Position 1 */
  font-size: 4rem;
}

/* State 2: Game Mode (Header Position, Smaller) */
.app-title.game-mode {
  top: 10px;
  font-size: 2.5rem;
}

/* --- NEW LAYOUT ARCHITECTURE --- */
.game-content-wrapper {
  flex: 1;
  display: flex;
  flex-direction: column;
  justify-content: center;
  align-items: center;
  width: 100%;
  gap: 20px;
  position: relative; /* Anchor for absolute children if needed */
}

/* --- COMPONENT CLEANUP --- */

/* Description follows normal flow INSIDE the absolute container */
.start-header {
  position: static;
  margin: 0 0 100px 0; /* Increased gap to button (was 20px) */
  width: 100%;
  text-align: center;
  pointer-events: none;
}

/* Button container NO LONGER follows flow. It is ABSOLUTE. */
#start-menu {
  position: absolute; /* Independent positioning */
  top: 25%; /* Restore user intended position */
  left: 0;
  width: 100%;
  height: auto;
  display: flex;
  flex-direction: column;
  justify-content: flex-start;
  align-items: center;
  margin: 0 !important;
  padding: 0 !important;
  gap: 0;
}

/* Mobile Adjustments */
@media (max-width: 600px) {
  .app-title.start-mode {
    top: 25%;
    font-size: 3rem;
  }
  .app-title.game-mode {
    top: 5px;
    font-size: 1.8rem;
  }

  /* Match Desktop Logic but Scaled */
  #start-menu {
    top: 25%; /* Align start point with desktop */
    margin-top: 0;
    padding-top: 0px !important; /* Push text below Title */
  }

  .start-header {
    top: auto;
    margin-bottom: 80px; /* Scaled down from 100px */
  }
}

/* Very Small Mobile Adjustments (320px) */
@media (max-width: 350px) {
  .game-subtitle {
    font-size: 1.2rem; /* Reduce subtitle size */
  }
}

/* Adjust Subtitle Position for Mobile (425px) */
@media (max-width: 426px) {
  .panel-header {
    margin-top: 25px;
  }

  /* TIGHTER SPACING FOR GAME ELEMENTS */
  .game-content-wrapper {
    gap: 5px; /* Reduced from 20px */
  }

  #main-board {
    margin-bottom: 5px;
  }

  .collected-container {
    margin-bottom: 0px; /* Reduced to ZERO */
  }

  /* Extra tight gap for the layout container itself */
  .memory-layout {
    gap: 2px;
  }

  /* Force lift cards */
  .memory-board {
    margin-top: -30px;
  }
}

/* Intermediate Desktop (Tablets/Small Laptops) 768px - 1024px */
@media (min-width: 768px) and (max-width: 1023px) {
  .jigsaw-piece {
    width: 90px; /* Reduced from 120px */
    height: 90px;
  }

  .jigsaw-cell {
    width: 30px; /* Reduced from 40px */
    height: 30px;
    font-size: 1rem;
  }
}
